<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneDrop Marketplace (modern)</title>
  <link rel="stylesheet" href="styles.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
</head>
<body>
  <header id="mainHeader">
    <div class="logo"><i class="fas fa-gem"></i></div>
    <div>OneDrop│ Letztes Update am 6. SEPTEMBER 2025 vollzogen</div>
    
    <!-- Suchfeld im Header -->
    <div class="search-container">
      <input type="text" class="search-input" id="searchInput" placeholder="Suchen...">
      <button class="search-btn" id="searchBtn">
        <i class="fas fa-search"></i>
      </button>
      <button class="search-close" id="searchClose">
        &times;
      </button>
    </div>

    <!-- Benachrichtigungsglocke -->
    <div class="notification-bell" id="notificationBell">
      <i class="fas fa-bell"></i>
      <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
    </div>
  </header>

  <div class="categories" id="categoriesContainer">
    <button class="category-btn active" data-category="all">
      <i class="fas fa-th"></i> Alle
    </button>
    <button class="category-btn" data-category="electronics">
      <i class="fas fa-laptop"></i> Elektronik
    </button>
    <button class="category-btn" data-category="clothing">
      <i class="fas fa-tshirt"></i> Kleidung
    </button>
    <button class="category-btn" data-category="bike">
      <i class="fas fa-bicycle"></i> Fahrrad
    </button>
    <button class="category-btn" data-category="other">
      <i class="fas fa-box"></i> Sonstiges
    </button>
  </div>

  <div class="products" id="productContainer"></div>

  <div id="uploadModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <form id="uploadForm">
      <h2 class="form-title"><i class="fas fa-cloud-upload-alt"></i> Neues Produkt</h2>

      <div class="form-group">
        <label for="titleInput"><i class="fas fa-tag"></i> Produktname</label>
        <input type="text" id="titleInput" placeholder="Premium Smartwatch" required />
      </div>

      <div class="form-group">
        <label for="descriptionInput"><i class="fas fa-align-left"></i> Beschreibung</label>
        <textarea id="descriptionInput" placeholder="Ausführliche Produktbeschreibung..." rows="3"></textarea>
      </div>

      <div class="input-row">
        <div class="form-group">
          <label for="startInput"><i class="fas fa-arrow-up"></i> Startpreis (€)</label>
          <input type="number" id="startInput" placeholder="199.99" step="0.01" min="0" required />
        </div>

        <div class="form-group">
          <label for="minInput"><i class="fas fa-arrow-down"></i> Minimalpreis (€)</label>
          <input type="number" id="minInput" placeholder="99.99" step="0.01" min="0" required />
        </div>
      </div>

      <div class="input-row">
        <div class="form-group">
          <label for="dropInput"><i class="fas fa-hourglass-half"></i> Preisabfall/Min (€)</label>
          <input type="number" id="dropInput" placeholder="10.00" step="0.01" min="0" required />
        </div>

        <div class="form-group">
          <label for="timerInput"><i class="fas fa-stopwatch"></i> Timer (Minuten)</label>
          <input type="number" id="timerInput" placeholder="5" min="1" required />
        </div>
      </div>

      <div class="input-row">
        <div class="form-group">
          <label for="categoryInput"><i class="fas fa-folder"></i> Kategorie</label>
          <select id="categoryInput" required>
            <option value="">Bitte wählen</option>
            <option value="electronics">Elektronik</option>
            <option value="clothing">Kleidung</option>
            <option value="bike">Fahrrad</option>
            <option value="other">Sonstiges</option>
          </select>
        </div>

        <div class="form-group" id="conditionGroup">
          <label for="conditionInput"><i class="fas fa-star"></i> Zustand</label>
          <select id="conditionInput" required>
            <option value="">Bitte Kategorie wählen</option>
          </select>
        </div>
      </div>

      <div class="form-group" id="sizeGroup" style="display: none;">
        <label for="sizeInput"><i class="fas fa-ruler"></i> Größe</label>
        <input type="text" id="sizeInput" placeholder="Größe (z.B. M, 42, 10.5)" />
      </div>

      <div class="form-group" id="modelGroup" style="display: none;">
        <label for="modelInput"><i class="fas fa-microchip"></i> Modell</label>
        <input type="text" id="modelInput" placeholder="Modellbezeichnung" />
      </div>

      <div class="form-group">
        <label><i class="fas fa-images"></i> Produktbilder</label>
        <div class="file-upload" id="fileUploadArea">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Klicken zum Hochladen oder Dateien hierher ziehen</p>
          <p class="small">(Mehrere Dateien möglich)</p>
          <input type="file" id="imageInput" accept="image/*" multiple style="display:none;" />
        </div>
      </div>

      <div class="preview-container" id="previewContainer">
        <p>Ausgewählte Bilder:</p>
        <div class="preview-grid" id="previewGrid"></div>
      </div>

      <button type="submit" class="action-button"><i class="fas fa-plus-circle"></i> Produkt hinzufügen</button>
    </form>
  </div>

  <div id="productModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <div id="productDetails">
      <!-- Content will be filled by JavaScript -->
    </div>
  </div>

  <!-- Intro Modal -->
  <div id="introModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <div id="introContent">
      <h2 class="intro-title"><i class="fas fa-graduation-cap"></i> OneDrop Tutorial</h2>
      <div class="intro-steps">
        <div class="intro-step">
          <div class="step-number">1</div>
          <div>
            <strong>Produkte durchsuchen</strong>
            <p>Durchstöbere alle verfügbaren Produkte oder filtere nach Kategorien</p>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-number">2</div>
          <div>
            <strong>Preise beobachten</strong>
            <p>Die Preise fallen kontinuierlich - kaufe zum niedrigstmöglichen Preis!</p>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-number">3</div>
          <div>
            <strong>Schnell zuschlagen</strong>
            <p>Wenn dir ein Preis gefällt, klicke auf "Jetzt kaufen" bevor es jemand anderer tut</p>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-number">4</div>
          <div>
            <strong>Eigene Produkte verkaufen</strong>
            <p>Nutze das "+" Symbol um eigene Produkte zum Verkauf anzubieten</p>
          </div>
        </div>
      </div>
      <div class="intro-footer">
        <button class="intro-skip" id="introSkip">Überspringen</button>
        <button class="intro-next action-button" id="introNext">Verstanden!</button>
      </div>
    </div>
  </div>

  <!-- Verkäuferprofil Modal -->
  <div id="profileModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <div id="profileContent">
      <!-- Content will be filled by JavaScript -->
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chatModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <div id="chatContent">
      <h2 class="chat-title"><i class="fas fa-comments"></i> Chat mit Verkäufer</h2>
      <div class="chat-messages" id="chatMessages">
        <!-- Nachrichten werden hier eingefügt -->
      </div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Nachricht eingeben...">
        <button id="sendMessageBtn" class="action-button"><i class="fas fa-paper-plane"></i> Senden</button>
      </div>
    </div>
  </div>

  <!-- Bewertungs Modal -->
  <div id="ratingModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <div id="ratingContent">
      <h2 class="rating-title"><i class="fas fa-star"></i> Verkäufer bewerten</h2>
      <div class="form-group">
        <label>Wie viele Sterne vergibst du?</label>
        <div class="star-rating" id="starRating">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>
      <div class="form-group">
        <label for="ratingComment"><i class="fas fa-comment"></i> Kommentar (optional)</label>
        <textarea id="ratingComment" placeholder="Deine Erfahrung mit diesem Verkäufer..." rows="3"></textarea>
      </div>
      <button id="submitRatingBtn" class="action-button"><i class="fas fa-check"></i> Bewertung abschicken</button>
    </div>
  </div>

  <!-- Benachrichtigungs Modal -->
  <div id="notificationModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <div id="notificationContent">
      <h2 class="notification-title"><i class="fas fa-bell"></i> Benachrichtigungen</h2>
      <div class="notification-list" id="notificationList">
        <!-- Benachrichtigungen werden hier eingefügt -->
      </div>
      <button id="clearNotificationsBtn" class="action-button danger-button"><i class="fas fa-trash"></i> Alle löschen</button>
    </div>
  </div>

  <!-- Versandoptionen Modal -->
  <div id="shippingModal">
    <button class="close-modal" aria-label="Modal schließen">&times;</button>
    <div id="shippingContent">
      <h2 class="shipping-title"><i class="fas fa-truck"></i> Versandoptionen</h2>
      <div class="shipping-options" id="shippingOptions">
        <div class="shipping-option">
          <input type="radio" id="standardShipping" name="shipping" value="standard" checked>
          <label for="standardShipping">
            <strong>Standardversand</strong>
            <p>3-5 Werktage - Kostenlos</p>
          </label>
        </div>
        <div class="shipping-option">
          <input type="radio" id="expressShipping" name="shipping" value="express">
          <label for="expressShipping">
            <strong>Expressversand</strong>
            <p>1-2 Werktage - 4,99 €</p>
          </label>
        </div>
        <div class="shipping-option">
          <input type="radio" id="pickupShipping" name="shipping" value="pickup">
          <label for="pickupShipping">
            <strong>Abholung</strong>
            <p>Selbstabholung - Kostenlos</p>
          </label>
        </div>
      </div>
      <button id="confirmShippingBtn" class="action-button"><i class="fas fa-check"></i> Versandart bestätigen</button>
    </div>
  </div>

  <button id="createBtn" aria-label="Neues Produkt erstellen">+</button>

  <div class="mobile-actions">
    <button class="mobile-action-btn active" id="mobileHomeBtn">
      <i class="fas fa-home"></i>
      <span>Start</span>
    </button>
    <button class="mobile-action-btn" id="mobileCategoryBtn">
      <i class="fas fa-th-large"></i>
      <span>Kategorien</span>
    </button>
    <button class="mobile-action-btn" id="mobileUploadBtn">
      <i class="fas fa-plus"></i>
      <span>Hinzufügen</span>
    </button>
    <button class="mobile-action-btn" id="mobileProfileBtn">
      <i class="fas fa-user"></i>
      <span>Profil</span>
    </button>
  </div>

  <div class="confetti-container" id="confettiContainer"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // Prüfen, ob das Intro bereits angezeigt wurde
    const introShown = localStorage.getItem('introShown');
    
    // Globale Animation State
    let animationFrameId = null;
    let lastAnimationTime = 0;
    const animationInterval = 100; // ms between animation updates
    
    // Verbesserte, robuste Zahl-Animationsfunktion
    function animateNumberChange(element, newValue, prefix = '') {
      const oldValue = element.dataset.value !== undefined ? String(element.dataset.value) : '';
      const newStrRaw = String(newValue);

      // store new value
      element.dataset.value = newStrRaw;

      // prepare strings with same length (right-aligned) so digits align
      const maxLen = Math.max(oldValue.length, newStrRaw.length);
      const oldStr = oldValue.padStart(maxLen, ' ');
      const newStr = newStrRaw.padStart(maxLen, ' ');

      // build HTML
      let html = '';
      if (prefix) html += `<span class="num-prefix">${prefix}</span>`;

      for (let i = 0; i < maxLen; i++) {
        const o = oldStr[i];
        const n = newStr[i];

        // treat punctuation (.:,) and spaces as static characters
        if (o === n || /[\s\:\.,]/.test(n)) {
          html += `<span class="static-char">${n}</span>`;
        } else {
          // different -> create sliding digit
          html += `<span class="digit" data-new="${n}"><span class="digit-inner"><span class="digit-old">${o}</span><span class="digit-new">${n}</span></span></span>`;
        }
      }

      element.innerHTML = html;

      // trigger animation on next frame
      requestAnimationFrame(() => {
        const digits = element.querySelectorAll('.digit');
        digits.forEach(d => {
          const inner = d.querySelector('.digit-inner');
          // start transform
          inner.style.transform = 'translateY(-100%)';

          // after transition: replace with static final char to keep DOM small
          const cleanup = () => {
            const newChar = d.getAttribute('data-new') || (d.querySelector('.digit-new')?.textContent || '');
            const span = document.createElement('span');
            span.className = 'static-char';
            span.textContent = newChar;
            d.parentNode.replaceChild(span, d);
          };

          inner.addEventListener('transitionend', cleanup, { once: true });

          // safety fallback
          setTimeout(() => {
            if (d.parentNode) cleanup();
          }, 700);
        });
      });
    }

    // Kontinuierliche Animation für alle Produkte
    function startContinuousAnimation() {
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      
      const animate = (timestamp) => {
        if (!lastAnimationTime) lastAnimationTime = timestamp;
        const elapsed = timestamp - lastAnimationTime;
        
        if (elapsed > animationInterval) {
          updateAllProductAnimations();
          lastAnimationTime = timestamp;
        }
        
        animationFrameId = requestAnimationFrame(animate);
      };
      
      animationFrameId = requestAnimationFrame(animate);
    }
    
    function updateAllProductAnimations() {
      const productCards = document.querySelectorAll('.product-card');
      productCards.forEach(card => {
        const productId = card.dataset.id;
        const productData = products.find(p => p.id === productId);
        
        if (productData && !productData.sold) {
          updateProductAnimation(productData);
        }
      });
    }
    
    function updateProductAnimation(productData) {
      const elapsed = (Date.now() - new Date(productData.createdAt).getTime()) / 1000;
      const dropInterval = productData.timer * 60;
      const dropsOccurred = Math.floor(elapsed / dropInterval);
      const newPrice = Math.max(productData.min, productData.start - productData.drop * dropsOccurred);
      
      const priceValue = document.getElementById(`priceValue-${productData.id}`);
      if (priceValue) {
        const currentDisplayPrice = parseFloat(priceValue.dataset.value || productData.start);
        if (Math.abs(newPrice - currentDisplayPrice) >= 0.01) {
          animateNumberChange(priceValue, newPrice.toFixed(2), '€');
        }
      }
      
      const timeToNextDrop = Math.max(0, Math.ceil(dropInterval - (elapsed % dropInterval)));
      const minutes = Math.floor(timeToNextDrop / 60);
      const seconds = timeToNextDrop % 60;
      const timerStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
      
      const timerValue = document.getElementById(`timerValue-${productData.id}`);
      if (timerValue && timerValue.dataset.value !== timerStr) {
        animateNumberChange(timerValue, timerStr);
      }
    }

    // Confetti
    function createConfetti() {
      const container = document.getElementById('confettiContainer');
      container.style.display = 'block';
      container.innerHTML = '';
      const colors = ['#00ffcc', '#00ccff', '#ff6b6b', '#ffcc00', '#cc00ff'];
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.width = `${Math.random() * 6 + 3}px`;
        confetti.style.height = `${Math.random() * 6 + 3}px`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = `${Math.random() * 2}s`;
        confetti.style.opacity = Math.random();
        container.appendChild(confetti);
      }
      setTimeout(() => {
        container.style.display = 'none';
      }, 5000);
    }

    // Kategorie- und Zustandsdaten
    const categories = {
      electronics: {
        name: "Elektronik",
        conditions: ["Neu", "Gebraucht", "Refurbished", "Defekt"],
        color: "var(--category-electronics)"
      },
      clothing: {
        name: "Kleidung",
        conditions: ["Neu mit Etikett", "Neu ohne Etikett", "Sehr gut", "Gut", "Akzeptabel"],
        color: "var(--category-clothing)"
      },
      bike: {
        name: "Fahrrad",
        conditions: ["Neu", "Gebraucht", "Restauriert", "Vintage"],
        color: "var(--category-bike)"
      },
      thegoat: {
        name: "THE GOAT",
        conditions: ["Neu", "Gebraucht", "Restauriert", "Vintage"],
        color: "var(--category-other)"
      },
      other: {
        name: "Sonstiges",
        conditions: ["Neu", "Gebraucht", "Antik", "Sammlerstück"],
        color: "var(--category-other)"
      }
    };

    // DOM-Elemente
    const containerEl = document.getElementById('productContainer');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const mainHeader = document.getElementById('mainHeader');
    const createBtn = document.getElementById('createBtn');
    const uploadModal = document.getElementById('uploadModal');
    const productModal = document.getElementById('productModal');
    const introModal = document.getElementById('introModal');
    const profileModal = document.getElementById('profileModal');
    const chatModal = document.getElementById('chatModal');
    const ratingModal = document.getElementById('ratingModal');
    const notificationModal = document.getElementById('notificationModal');
    const shippingModal = document.getElementById('shippingModal');
    const uploadForm = document.getElementById('uploadForm');
    const closeModals = document.querySelectorAll('.close-modal');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewGrid = document.getElementById('previewGrid');
    const categoryInput = document.getElementById('categoryInput');
    const conditionInput = document.getElementById('conditionInput');
    const sizeGroup = document.getElementById('sizeGroup');
    const modelGroup = document.getElementById('modelGroup');
    const mobileUploadBtn = document.getElementById('mobileUploadBtn');
    const mobileHomeBtn = document.getElementById('mobileHomeBtn');
    const mobileCategoryBtn = document.getElementById('mobileCategoryBtn');
    const mobileProfileBtn = document.getElementById('mobileProfileBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const searchClose = document.getElementById('searchClose');
    const introSkip = document.getElementById('introSkip');
    const introNext = document.getElementById('introNext');
    const notificationBell = document.getElementById('notificationBell');
    const notificationBadge = document.getElementById('notificationBadge');
    const notificationList = document.getElementById('notificationList');
    const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const starRating = document.getElementById('starRating');
    const ratingComment = document.getElementById('ratingComment');
    const submitRatingBtn = document.getElementById('submitRatingBtn');
    const shippingOptions = document.getElementById('shippingOptions');
    const confirmShippingBtn = document.getElementById('confirmShippingBtn');

    let uploadedImages = [];
    let products = [];
    let currentCategory = 'all';
    let lastScrollTop = 0;
    let currentSeller = null;
    let currentProductForRating = null;
    let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    let ratings = JSON.parse(localStorage.getItem('ratings')) || [];
    let chats = JSON.parse(localStorage.getItem('chats')) || {};
    let detailPriceInterval = null;

    // Funktionen zum Verstecken/Anzeigen von Header und Kategorien
    function hideHeaderAndCategories() {
      mainHeader.classList.add('header-hidden');
      categoriesContainer.classList.add('categories-hidden');
    }
    
    function showHeaderAndCategories() {
      mainHeader.classList.remove('header-hidden');
      categoriesContainer.classList.remove('categories-hidden');
    }

    // Intro Modal anzeigen, wenn noch nicht gezeigt
    if (!introShown) {
      setTimeout(() => {
        introModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        hideHeaderAndCategories();
      }, 1000);
    }

    // Intro Modal schließen
    introSkip.addEventListener('click', closeIntro);
    introNext.addEventListener('click', closeIntro);

    function closeIntro() {
      introModal.style.display = 'none';
      document.body.style.overflow = '';
      showHeaderAndCategories();
      localStorage.setItem('introShown', 'true');
    }

    // Suchfunktionalität
    searchBtn.addEventListener('click', () => {
      searchInput.classList.toggle('active');
      if (searchInput.classList.contains('active')) {
        searchInput.focus();
      }
    });

    searchClose.addEventListener('click', () => {
      searchInput.classList.remove('active');
      searchInput.value = '';
      filterProducts();
    });

    searchInput.addEventListener('input', () => {
      filterProducts();
    });

    // Benachrichtigungen aktualisieren
    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      if (unreadCount > 0) {
        notificationBadge.textContent = unreadCount;
        notificationBadge.style.display = 'flex';
      } else {
        notificationBadge.style.display = 'none';
      }
    }

    // Benachrichtigung hinzufügen
    function addNotification(title, message, type = 'info') {
      const newNotification = {
        id: Date.now(),
        title,
        message,
        type,
        timestamp: new Date().toISOString(),
        read: false
      };
      
      notifications.unshift(newNotification);
      localStorage.setItem('notifications', JSON.stringify(notifications));
      updateNotificationBadge();
      
      // Push-Benachrichtigung anzeigen (wenn erlaubt)
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body: message, icon: '/favicon.ico' });
      }
    }

    // Benachrichtigungen anfordern
    function requestNotificationPermission() {
      if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            addNotification('Benachrichtigungen aktiviert', 'Du wirst nun über wichtige Ereignisse benachrichtigt.');
          }
        });
      }
    }

    // Benachrichtigungsglocke
    notificationBell.addEventListener('click', () => {
      notificationModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      hideHeaderAndCategories();
      renderNotifications();
    });

    // Benachrichtigungen rendern
    function renderNotifications() {
      notificationList.innerHTML = '';
      
      if (notifications.length === 0) {
        notificationList.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Keine Benachrichtigungen</p>';
        return;
      }
      
      notifications.forEach(notification => {
        const notificationItem = document.createElement('div');
        notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
        notificationItem.innerHTML = `
          <h4>${notification.title}</h4>
          <p>${notification.message}</p>
          <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
        `;
        
        notificationItem.addEventListener('click', () => {
          notification.read = true;
          localStorage.setItem('notifications', JSON.stringify(notifications));
          updateNotificationBadge();
          notificationItem.classList.remove('unread');
        });
        
        notificationList.appendChild(notificationItem);
      });
    }

    // Benachrichtigungen löschen
    clearNotificationsBtn.addEventListener('click', () => {
      notifications = [];
      localStorage.setItem('notifications', JSON.stringify(notifications));
      updateNotificationBadge();
      renderNotifications();
    });

    // Favoriten-Funktion
    function toggleFavorite(productId) {
      const index = favorites.indexOf(productId);
      if (index === -1) {
        favorites.push(productId);
        addNotification('Favorit hinzugefügt', 'Produkt wurde zu deinen Favoriten hinzugefügt.');
      } else {
        favorites.splice(index, 1);
        addNotification('Favorit entfernt', 'Produkt wurde aus deinen Favoriten entfernt.');
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      filterProducts();
    }

    // Favoriten-Button aktualisieren
    function updateFavoriteButton(productId, button) {
      const isFavorite = favorites.includes(productId);
      button.innerHTML = isFavorite ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart"></i>';
      button.classList.toggle('active', isFavorite);
    }

    // Scroll-Verhalten für Header und Kategorien
    window.addEventListener('scroll', function() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      // Nur auf Mobilgeräten anwenden, wenn keine Modals geöffnet sind
      if (window.innerWidth <= 768 && 
          uploadModal.style.display !== 'flex' && 
          productModal.style.display !== 'flex' &&
          introModal.style.display !== 'flex') {
        if (scrollTop > lastScrollTop && scrollTop > 100) {
          // Nach unten scrollen - Header und Kategorien ausblenden
          mainHeader.classList.add('header-hidden');
          categoriesContainer.classList.add('categories-hidden');
        } else {
          // Nach oben scrollen - Header und Kategorien einblenden
          mainHeader.classList.remove('header-hidden');
          categoriesContainer.classList.remove('categories-hidden');
        }
      }
      
      lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }, false);

    // Mobile Navigation
    mobileUploadBtn.addEventListener('click', () => {
      uploadModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      window.scrollTo(0, 0);
      setActiveMobileButton(mobileUploadBtn);
      hideHeaderAndCategories();
    });

    mobileHomeBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      setActiveMobileButton(mobileHomeBtn);
    });

    mobileCategoryBtn.addEventListener('click', () => {
      categoriesContainer.scrollIntoView({ behavior: 'smooth' });
      setActiveMobileButton(mobileCategoryBtn);
    });

    mobileProfileBtn.addEventListener('click', () => {
      showProfile();
      setActiveMobileButton(mobileProfileBtn);
    });

    function setActiveMobileButton(activeBtn) {
      document.querySelectorAll('.mobile-action-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      activeBtn.classList.add('active');
    }

    // Profil anzeigen
    function showProfile() {
      profileModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      hideHeaderAndCategories();
      
      // Berechne durchschnittliche Bewertung
      const userRatings = ratings.filter(r => r.sellerId === 'default-user');
      const avgRating = userRatings.length > 0 
        ? userRatings.reduce((sum, r) => sum + r.rating, 0) / userRatings.length 
        : 0;
      
      profileContent.innerHTML = `
        <h2 class="profile-title"><i class="fas fa-user"></i> Dein Profil</h2>
        <div class="seller-info">
          <img src="https://placehold.co/100x100/00ffcc/000000?text=DU" alt="Dein Profil" class="seller-avatar">
          <div>
            <h3>Dein Benutzername</h3>
            <div class="seller-rating">
              ${Array(5).fill(0).map((_, i) => 
                `<span class="star ${i < Math.round(avgRating) ? 'active' : ''}">★</span>`
              ).join('')}
              <span>(${avgRating.toFixed(1)})</span>
            </div>
            <p>${userRatings.length} Bewertungen</p>
          </div>
        </div>
        
        <div class="product-detail-row">
          <div class="product-detail-label">Favoriten:</div>
          <div class="product-detail-value">${favorites.length} Produkte</div>
        </div>
        
        <div class="product-detail-row">
          <div class="product-detail-label">Verkaufte Produkte:</div>
          <div class="product-detail-value">${products.filter(p => p.sellerId === 'default-user' && p.sold).length}</div>
        </div>
        
        <div style="margin-top: 1.5rem;">
          <h3><i class="fas fa-cog"></i> Einstellungen</h3>
          <button id="requestNotificationsBtn" class="action-button" style="width: 100%; margin-top: 0.8rem;">
            <i class="fas fa-bell"></i> Benachrichtigungen aktivieren
          </button>
        </div>
      `;
      
      // Benachrichtigungen anfordern
      document.getElementById('requestNotificationsBtn').addEventListener('click', requestNotificationPermission);
    }

    // Kategorie-Filter
    categoriesContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('category-btn')) {
        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        currentCategory = e.target.dataset.category;
        filterProducts();
      }
    });

    function filterProducts() {
      containerEl.innerHTML = '';
      let filtered = currentCategory === 'all' ? products : products.filter(p => p.category === currentCategory);
      
      // Suchfilter anwenden, wenn Suchbegriff vorhanden
      const searchTerm = searchInput.value.toLowerCase().trim();
      if (searchTerm) {
        filtered = filtered.filter(product => 
          product.title.toLowerCase().includes(searchTerm) || 
          product.description.toLowerCase().includes(searchTerm)
        );
      }
      
      filtered.forEach(product => createProductCard(product));
      
      // Suchhinweis anzeigen, wenn keine Ergebnisse
      if (filtered.length === 0 && searchTerm) {
        containerEl.innerHTML = `
          <div class="no-results" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
            <i class="fas fa-search" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
            <h3>Keine Treffer</h3>
            <p>Versuche einen anderen Suchbegriff</p>
          </div>
        `;
      }
      
      // Starte kontinuierliche Animation
      startContinuousAnimation();
    }

    // category change -> populate conditions
    categoryInput.addEventListener('change', () => {
      const category = categoryInput.value;
      conditionInput.innerHTML = '<option value="">Bitte wählen</option>';
      if (category && categories[category]) {
        categories[category].conditions.forEach(condition => {
          const option = document.createElement('option');
          option.value = condition;
          option.textContent = condition;
          conditionInput.appendChild(option);
        });
        if (category === 'clothing') { sizeGroup.style.display = 'flex'; modelGroup.style.display = 'none'; }
        else if (category === 'electronics') { sizeGroup.style.display = 'none'; modelGroup.style.display = 'flex'; }
        else { sizeGroup.style.display = 'none'; modelGroup.style.display = 'none'; }
      } else {
        conditionInput.innerHTML = '<option value="">Bitte Kategorie wählen</option>';
        sizeGroup.style.display = 'none';
        modelGroup.style.display = 'none';
      }
    });

    // Modals
    createBtn.addEventListener('click', () => {
      uploadModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      window.scrollTo(0, 0);
      hideHeaderAndCategories();
    });

    closeModals.forEach(btn => {
      btn.addEventListener('click', () => {
        uploadModal.style.display = 'none';
        productModal.style.display = 'none';
        introModal.style.display = 'none';
        profileModal.style.display = 'none';
        chatModal.style.display = 'none';
        ratingModal.style.display = 'none';
        notificationModal.style.display = 'none';
        shippingModal.style.display = 'none';
        document.body.style.overflow = '';
        resetForm();
        showHeaderAndCategories();
        
        // Stoppe das Intervall für die Detailansicht
        if (detailPriceInterval) {
          clearInterval(detailPriceInterval);
          detailPriceInterval = null;
        }
      });
    });

    uploadModal.addEventListener('click', (e) => {
      if (e.target === uploadModal) { 
        uploadModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        resetForm();
        showHeaderAndCategories();
      }
    });
    
    productModal.addEventListener('click', (e) => { 
      if (e.target === productModal) { 
        productModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        showHeaderAndCategories();
        
        // Stoppe das Intervall für die Detailansicht
        if (detailPriceInterval) {
          clearInterval(ddetailPriceInterval);
          detailPriceInterval = null;
        }
      } 
    });
    
    introModal.addEventListener('click', (e) => { 
      if (e.target === introModal) { 
        closeIntro();
      } 
    });

    profileModal.addEventListener('click', (e) => { 
      if (e.target === profileModal) { 
        profileModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        showHeaderAndCategories();
      } 
    });

    chatModal.addEventListener('click', (e) => { 
      if (e.target === chatModal) { 
        chatModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        showHeaderAndCategories();
      } 
    });

    ratingModal.addEventListener('click', (e) => { 
      if (e.target === ratingModal) { 
        ratingModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        showHeaderAndCategories();
      } 
    });

    notificationModal.addEventListener('click', (e) => { 
      if (e.target === notificationModal) { 
        notificationModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        showHeaderAndCategories();
      } 
    });

    shippingModal.addEventListener('click', (e) => { 
      if (e.target === shippingModal) { 
        shippingModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        showHeaderAndCategories();
      } 
    });

    // File upload
    fileUploadArea.addEventListener('click', () => imageInput.click());
    fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = 'var(--main)'; fileUploadArea.style.backgroundColor = 'rgba(0, 255, 204, 0.1)'; });
    fileUploadArea.addEventListener('dragleave', () => { fileUploadArea.style.borderColor = 'rgba(255, 255, 255, 0.1)'; fileUploadArea.style.backgroundColor = 'rgba(0, 0, 0, 0.2)'; });
    fileUploadArea.addEventListener('drop', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = 'rgba(255, 255, 255, 0.1)'; fileUploadArea.style.backgroundColor = 'rgba(0, 0, 0, 0.2)'; if (e.dataTransfer.files.length > 0) { imageInput.files = e.dataTransfer.files; handleFileUpload(e.dataTransfer.files); } });

    imageInput.addEventListener('change', function() { if (this.files.length > 0) handleFileUpload(this.files); });

    function handleFileUpload(files) {
      loadingOverlay.style.display = 'flex';
      
      // Simuliere Ladezeit für bessere UX
      setTimeout(() => {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.type.match('image.*')) continue;
          const reader = new FileReader();
          reader.onload = function(e) { 
            uploadedImages.push(e.target.result); 
            updatePreview(); 
          };
          reader.readAsDataURL(file);
        }
        loadingOverlay.style.display = 'none';
      }, 500);
    }

    function updatePreview() {
      previewGrid.innerHTML = '';
      if (uploadedImages.length > 0) {
        previewContainer.style.display = 'block';
        uploadedImages.forEach((img, index) => {
          const previewItem = document.createElement('div');
          previewItem.className = 'preview-item';
          previewItem.innerHTML = `
            <img src="${img}" alt="Preview ${index + 1}">
            <button class="remove" data-index="${index}">&times;</button>
          `;
          previewGrid.appendChild(previewItem);
        });
        document.querySelectorAll('.preview-item .remove').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            uploadedImages.splice(index, 1);
            updatePreview();
            e.stopPropagation();
          });
        });
      } else previewContainer.style.display = 'none';
    }

    function resetForm() {
      uploadForm.reset();
      uploadedImages = [];
      updatePreview();
      sizeGroup.style.display = 'none';
      modelGroup.style.display = 'none';
      conditionInput.innerHTML = '<option value="">Bitte Kategorie wählen</option>';
    }

    // Form submit
    uploadForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('titleInput').value.trim();
      const description = document.getElementById('descriptionInput').value.trim();
      const start = parseFloat(document.getElementById('startInput').value);
      const min = parseFloat(document.getElementById('minInput').value);
      const drop = parseFloat(document.getElementById('dropInput').value);
      const timer = parseInt(document.getElementById('timerInput').value, 10);
      const category = document.getElementById('categoryInput').value;
      const condition = document.getElementById('conditionInput').value;
      const size = document.getElementById('sizeInput')?.value || '';
      const model = document.getElementById('modelInput')?.value || '';

      if (!title || isNaN(start) || isNaN(min) || isNaN(drop) || isNaN(timer) || !category || !condition) {
        alert('Bitte alle Felder korrekt ausfüllen!');
        return;
      }
      if (start < min) { alert('Startpreis muss höher als Minimalpreis sein!'); return; }
      if (timer <= 0) { alert('Timer muss größer als 0 sein!'); return; }

      const productData = {
        title, description, start, min, drop, timer, category, condition, size, model,
        images: [...uploadedImages], id: Date.now().toString(), 
        createdAt: new Date().toISOString(),
        sellerId: 'default-user',
        sellerName: 'Dein Benutzername',
        sold: false
      };

      addProduct(productData);
      createConfetti();
      setTimeout(() => { 
        uploadModal.style.display = 'none'; 
        document.body.style.overflow = ''; 
        resetForm();
        showHeaderAndCategories();
        addNotification('Produkt hinzugefügt', `${title} wurde erfolgreich eingestellt.`);
      }, 1000);
    });

    function addProduct(productData) { 
      products.push(productData); 
      createProductCard(productData); 
      startContinuousAnimation();
    }

    function createProductCard(productData) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.dataset.id = productData.id;
      card.dataset.category = productData.category;

      // Favoriten-Button
      const favButton = document.createElement('button');
      favButton.className = `favorite-btn`;
      updateFavoriteButton(productData.id, favButton);
      favButton.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFavorite(productData.id);
        updateFavoriteButton(productData.id, favButton);
      });
      card.appendChild(favButton);

      // images
      const imagesContainer = document.createElement('div');
      imagesContainer.className = 'product-images';
      const mainImage = document.createElement('img');
      mainImage.className = 'main-image';
      mainImage.alt = productData.title;
      mainImage.src = productData.images.length > 0 ? productData.images[0] : 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="M21 15l-5-5L5 21"></path></svg>';
      imagesContainer.appendChild(mainImage);

      if (productData.images.length > 1) {
        const thumbnails = document.createElement('div'); thumbnails.className = 'thumbnails';
        productData.images.forEach((img, index) => {
          const thumb = document.createElement('img');
          thumb.className = `thumbnail ${index === 0 ? 'active' : ''}`;
          thumb.src = img; thumb.alt = `Thumbnail ${index+1}`; thumb.dataset.index = index;
          thumb.addEventListener('click', (e) => { mainImage.src = img; document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active')); thumb.classList.add('active'); e.stopPropagation(); });
          thumbnails.appendChild(thumb);
        });
        imagesContainer.appendChild(thumbnails);
      }

      card.appendChild(imagesContainer);

      // title
      const titleEl = document.createElement('div'); titleEl.className = 'product-title'; titleEl.innerHTML = `<i class="fas fa-cube"></i>${productData.title}`;
      const categoryEl = document.createElement('div'); categoryEl.className = `category-badge category-${productData.category}`; categoryEl.textContent = categories[productData.category]?.name || 'Sonstiges'; titleEl.appendChild(categoryEl);
      card.appendChild(titleEl);

      // Calculate initial price and timer
      const elapsed = (Date.now() - new Date(productData.createdAt).getTime()) / 1000;
      const dropInterval = productData.timer * 60;
      const dropsOccurred = Math.floor(elapsed / dropInterval);
      const currentPrice = Math.max(productData.min, productData.start - productData.drop * dropsOccurred);
      const timeToNextDrop = Math.max(0, Math.ceil(dropInterval - (elapsed % dropInterval)));
      const minutes = Math.floor(timeToNextDrop / 60);
      const seconds = timeToNextDrop % 60;
      const timerStr = `${minutes}:${String(seconds).padStart(2, '0')}`;

      // price
      const priceContainer = document.createElement('div'); priceContainer.className = 'price-container'; priceContainer.innerHTML = `
        <i class="fas fa-tag"></i>
        <div class="price">
          <span class="value" id="priceValue-${productData.id}">€${currentPrice.toFixed(2)}</span>
        </div>
      `;
      card.appendChild(priceContainer);
      const priceValue = priceContainer.querySelector('.value'); priceValue.dataset.value = currentPrice.toFixed(2);

      // timer
      const timerContainer = document.createElement('div'); timerContainer.className = 'timer-container'; timerContainer.innerHTML = `
        <i class="fas fa-clock"></i>
        <div class="timer">
          <span class="value" id="timerValue-${productData.id}">${timerStr}</span>
        </div>
      `;
      card.appendChild(timerContainer);
      const timerValue = timerContainer.querySelector('.value'); timerValue.dataset.value = timerStr;

      // condition
      const conditionEl = document.createElement('div'); conditionEl.className = 'condition-badge'; conditionEl.textContent = productData.condition; timerContainer.appendChild(conditionEl);

      // buy btn
      const btn = document.createElement('button'); btn.className = `buy-btn ${productData.sold ? 'sold' : ''}`; 
      if (productData.sold) {
        btn.innerHTML = '<i class="fas fa-check"></i><span>Verkauft!</span>';
      } else {
        btn.innerHTML = '<i class="fas fa-shopping-cart"></i><span>Jetzt kaufen</span>';
      }
      
      btn.addEventListener('click', (e) => {
        if (btn.classList.contains('sold')) return;
        
        // Produkt als verkauft markieren
        productData.sold = true;
        btn.classList.add('sold');
        btn.innerHTML = '<i class="fas fa-check"></i><span>Verkauft!</span>';
        
        // Benachrichtigung
        addNotification('Produkt gekauft', `Sie haben ${productData.title} gekauft!`);
        
        e.stopPropagation();
      });
      card.appendChild(btn);

      // Verkäuferinfo mit Bewertungsbutton
      const sellerInfo = document.createElement('div');
      sellerInfo.style.marginTop = '0.8rem';
      sellerInfo.style.display = 'flex';
      sellerInfo.style.justifyContent = 'space-between';
      sellerInfo.style.alignItems = 'center';
      sellerInfo.style.flexWrap = 'wrap';
      sellerInfo.style.gap = '0.5rem';
      
      const sellerText = document.createElement('div');
      sellerText.innerHTML = `Von: <span style="color: var(--main); cursor: pointer;" class="seller-link">${productData.sellerName}</span>`;
      sellerText.querySelector('.seller-link').addEventListener('click', (e) => {
        e.stopPropagation();
        openChat({
          id: productData.sellerId,
          name: productData.sellerName
        });
      });
      
      const ratingBtn = document.createElement('button');
      ratingBtn.innerHTML = '<i class="fas fa-star"></i> Bewerten';
      ratingBtn.className = 'secondary-button';
      ratingBtn.style.fontSize = '0.8rem';
      ratingBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentProductForRating = productData;
        ratingModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        hideHeaderAndCategories();
        
        // Sterne zurücksetzen
        starRating.querySelectorAll('.star').forEach(star => {
          star.classList.remove('active');
        });
        ratingComment.value = '';
      });
      
      sellerInfo.appendChild(sellerText);
      sellerInfo.appendChild(ratingBtn);
      card.appendChild(sellerInfo);

      // card click -> details
      card.addEventListener('click', (e) => { 
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return; 
        showProductDetails(productData); 
      });

      containerEl.appendChild(card);
    }

    // show product details
    function showProductDetails(productData) {
      const modalBody = document.getElementById('productDetails');
      
      // Stoppe vorheriges Intervall, falls vorhanden
      if (detailPriceInterval) {
        clearInterval(detailPriceInterval);
      }
      
      // Calculate current price and time
      const elapsed = (Date.now() - new Date(productData.createdAt).getTime()) / 1000;
      const dropInterval = productData.timer * 60;
      const dropsOccurred = Math.floor(elapsed / dropInterval);
      const currentPrice = Math.max(productData.min, productData.start - productData.drop * dropsOccurred);
      const timeToNextDrop = Math.max(0, Math.ceil(dropInterval - (elapsed % dropInterval)));
      const minutes = Math.floor(timeToNextDrop / 60);
      const seconds = timeToNextDrop % 60;
      const timerStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
      
      modalBody.innerHTML = `
        <h2 class="product-modal-title">
          <i class="fas fa-info-circle"></i> ${productData.title}
          <span class="category-badge category-${productData.category}">${categories[productData.category]?.name || 'Sonstiges'}</span>
        </h2>
        <div class="product-detail-content">
          <div class="product-detail-images">
            <img src="${productData.images.length > 0 ? productData.images[0] : 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="M21 15l-5-5L5 21"></path></svg>'}" alt="${productData.title}" class="product-main-image" id="detailMainImage">

            ${productData.images.length > 1 ? `
              <div class="product-thumbnails">
                ${productData.images.map((img, index) => `
                  <img src="${img}" class="product-thumbnail ${index === 0 ? 'active' : ''}" alt="Thumbnail ${index + 1}" data-index="${index}">
                `).join('')}
              </div>
            ` : ''}
          </div>

          <div class="product-detail-info">
            <div class="product-detail-row">
              <div class="product-detail-label">Aktueller Preis:</div>
              <div class="product-detail-value" id="detailPrice">€${currentPrice.toFixed(2)}</div>
            </div>
            <div class="product-detail-row">
              <div class="product-detail-label">Nächster Preisabfall in:</div>
              <div class="product-detail-value" id="detailTimer">${timerStr}</div>
            </div>
            <div class="product-detail-row">
              <div class="product-detail-label">Zustand:</div>
              <div class="product-detail-value"><span class="condition-badge">${productData.condition}</span></div>
            </div>
            ${productData.size ? `
              <div class="product-detail-row"><div class="product-detail-label">Größe:</div><div class="product-detail-value">${productData.size}</div></div>
            ` : ''}
            ${productData.model ? `
              <div class="product-detail-row"><div class="product-detail-label">Modell:</div><div class="product-detail-value">${productData.model}</div></div>
            ` : ''}
            <div class="product-detail-row"><div class="product-detail-label">Preisabfall:</div><div class="product-detail-value">€${productData.drop.toFixed(2)} pro Minute</div></div>
            <div class="product-detail-row"><div class="product-detail-label">Minimalpreis:</div><div class="product-detail-value">€${productData.min.toFixed(2)}</div></div>
            <div class="product-detail-row"><div class="product-detail-label">Startpreis:</div><div class="product-detail-value">€${productData.start.toFixed(2)}</div></div>
            <div class="product-detail-row">
              <div class="product-detail-label">Verkäufer:</div>
              <div class="product-detail-value">
                <span style="color: var(--main); cursor: pointer;" id="detailSeller">${productData.sellerName}</span>
                <button class="secondary-button" style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; font-size: 0.8rem;" id="chatWithSellerBtn">
                  <i class="fas fa-comment"></i> Chat
                </button>
              </div>
            </div>

            ${productData.description ? `
              <div class="product-description"><h3><i class="fas fa-align-left"></i> Beschreibung</h3><p>${productData.description}</p></div>
            ` : ''}

            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="buy-btn ${productData.sold ? 'sold' : ''}" id="modalBuyBtn" style="flex: 1;">
                <i class="fas ${productData.sold ? 'fa-check' : 'fa-shopping-cart'}"></i>
                <span>${productData.sold ? 'Verkauft!' : 'Jetzt kaufen'}</span>
              </button>
              <button id="setPriceAlarmBtn" class="secondary-button">
                <i class="fas fa-bell"></i>
              </button>
            </div>
          </div>
        </div>
      `;

      // thumbnails in details
      if (productData.images.length > 1) {
        document.querySelectorAll('.product-thumbnail').forEach(thumb => {
          thumb.addEventListener('click', () => {
            const idx = thumb.dataset.index;
            document.getElementById('detailMainImage').src = productData.images[idx];
            document.querySelectorAll('.product-thumbnail').forEach(t => t.classList.remove('active'));
            thumb.classList.add('active');
          });
        });
      }

      // Chat mit Verkäufer
      document.getElementById('detailSeller').addEventListener('click', () => {
        openChat({
          id: productData.sellerId,
          name: productData.sellerName
        });
      });

      document.getElementById('chatWithSellerBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        openChat({
          id: productData.sellerId,
          name: productData.sellerName
        });
      });

      // Preisalarm setzen
      document.getElementById('setPriceAlarmBtn').addEventListener('click', () => {
        const targetPrice = prompt('Bei welchem Preis möchtest du benachrichtigt werden? (€)');
        if (targetPrice && !isNaN(parseFloat(targetPrice))) {
          addNotification('Preisalarm gesetzt', `Du wirst benachrichtigt, wenn der Preis von ${productData.title} unter €${parseFloat(targetPrice).toFixed(2)} fällt.`);
        }
      });

      // Kaufbutton im Modal
      document.getElementById('modalBuyBtn').addEventListener('click', () => {
        if (productData.sold) return;
        
        // Produkt als verkauft markieren
        productData.sold = true;
        document.getElementById('modalBuyBtn').classList.add('sold');
        document.getElementById('modalBuyBtn').innerHTML = '<i class="fas fa-check"></i><span>Verkauft!</span>';
        
        // Benachrichtigung
        addNotification('Produkt gekauft', `Sie haben ${productData.title} gekauft!`);
        
        // Schließe das Modal nach dem Kauf
        setTimeout(() => {
          productModal.style.display = 'none';
          document.body.style.overflow = '';
          showHeaderAndCategories();
          
          // Aktualisiere die Produktliste
          filterProducts();
        }, 1500);
      });

      productModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      window.scrollTo(0, 0);
      hideHeaderAndCategories();
      
      // Starte Animation für die Detailansicht
      detailPriceInterval = setInterval(() => {
        const elapsed = (Date.now() - new Date(productData.createdAt).getTime()) / 1000;
        const dropInterval = productData.timer * 60;
        const dropsOccurred = Math.floor(elapsed / dropInterval);
        const newPrice = Math.max(productData.min, productData.start - productData.drop * dropsOccurred);
        
        const detailPriceEl = document.getElementById('detailPrice');
        if (detailPriceEl) {
          detailPriceEl.textContent = `€${newPrice.toFixed(2)}`;
        }
        
        const timeToNextDrop = Math.max(0, Math.ceil(dropInterval - (elapsed % dropInterval)));
        const minutes = Math.floor(timeToNextDrop / 60);
        const seconds = timeToNextDrop % 60;
        const timerStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
        
        const detailTimerEl = document.getElementById('detailTimer');
        if (detailTimerEl) {
          detailTimerEl.textContent = timerStr;
        }
      }, 1000);
    }

    // Chat-Funktion
    function openChat(seller) {
      currentSeller = seller;
      chatModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      hideHeaderAndCategories();
      renderChatMessages();
    }

    // Nachrichten rendern
    function renderChatMessages() {
      chatMessages.innerHTML = '';
      
      const chatId = `chat_${currentSeller.id}`;
      if (!chats[chatId]) {
        chats[chatId] = [];
      }
      
      if (chats[chatId].length === 0) {
        chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Noch keine Nachrichten</p>';
        return;
      }
      
      chats[chatId].forEach(message => {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${message.sender === 'user' ? 'sent' : 'received'}`;
        messageEl.innerHTML = `
          <p>${message.text}</p>
          <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
        `;
        chatMessages.appendChild(messageEl);
      });
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Nachricht senden
    sendMessageBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const messageText = chatInput.value.trim();
      if (!messageText) return;
      
      const chatId = `chat_${currentSeller.id}`;
      if (!chats[chatId]) {
        chats[chatId] = [];
      }
      
      const newMessage = {
        id: Date.now(),
        text: messageText,
        sender: 'user',
        timestamp: new Date().toISOString()
      };
      
      chats[chatId].push(newMessage);
      localStorage.setItem('chats', JSON.stringify(chats));
      
      // Simuliere eine Antwort nach 2 Sekunden
      setTimeout(() => {
        const responseMessage = {
          id: Date.now() + 1,
          text: 'Vielen Dank für Ihre Nachricht. Wir werden uns so schnell wie möglich bei Ihnen melden.',
          sender: 'seller',
          timestamp: new Date().toISOString()
        };
        
        chats[chatId].push(responseMessage);
        localStorage.setItem('chats', JSON.stringify(chats));
        renderChatMessages();
        addNotification('Neue Nachricht', `Neue Antwort von ${currentSeller.name}`);
      }, 2000);
      
      chatInput.value = '';
      renderChatMessages();
    }

    // Versandoptionen
    function showShippingOptions(product) {
      shippingModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      hideHeaderAndCategories();
      
      // Event-Listener für Auswahl
      shippingOptions.querySelectorAll('.shipping-option').forEach(option => {
        option.addEventListener('click', () => {
          shippingOptions.querySelectorAll('.shipping-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          option.querySelector('input[type="radio"]').checked = true;
        });
      });
      
      // Bestätigen-Button
      confirmShippingBtn.onclick = () => {
        const selectedOption = shippingOptions.querySelector('input[name="shipping"]:checked').value;
        let shippingText = '';
        let shippingCost = 0;
        
        switch(selectedOption) {
          case 'standard':
            shippingText = 'Standardversand (3-5 Werktage)';
            break;
          case 'express':
            shippingText = 'Expressversand (1-2 Werktage)';
            shippingCost = 4.99;
            break;
          case 'pickup':
            shippingText = 'Abholung';
            break;
        }
        
        addNotification('Versandart gewählt', `${shippingText} für ${product.title}`);
        shippingModal.style.display = 'none';
        document.body.style.overflow = '';
        showHeaderAndCategories();
        
        // Hier würde normalerweise der Kaufprozess fortgesetzt
        alert(`Versandart: ${shippingText}${shippingCost > 0 ? ` - Kosten: €${shippingCost.toFixed(2)}` : ''}`);
      };
    }

    // Bewertungsfunktion
    function rateSeller(product, ratingValue, comment) {
      const rating = {
        id: Date.now(),
        productId: product.id,
        sellerId: product.sellerId,
        rating: ratingValue,
        comment: comment || '',
        timestamp: new Date().toISOString()
      };
      
      ratings.push(rating);
      localStorage.setItem('ratings', JSON.stringify(ratings));
      
      addNotification('Bewertung abgegeben', 'Vielen Dank für deine Bewertung!');
      ratingModal.style.display = 'none';
      document.body.style.overflow = '';
      showHeaderAndCategories();
    }

    // Sterne-Bewertung
    starRating.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', () => {
        const value = parseInt(star.dataset.value);
        starRating.querySelectorAll('.star').forEach(s => {
          if (parseInt(s.dataset.value) <= value) {
            s.classList.add('active');
          } else {
            s.classList.remove('active');
          }
        });
      });
    });

    // Bewertung abschicken
    submitRatingBtn.addEventListener('click', () => {
      const activeStars = starRating.querySelectorAll('.star.active');
      if (activeStars.length === 0) {
        addNotification('Bewertung fehlt', 'Bitte wähle eine Sterne-Bewertung aus.');
        return;
      }
      
      const ratingValue = activeStars.length;
      const comment = ratingComment.value.trim();
      rateSeller(currentProductForRating, ratingValue, comment);
    });

    // Beispielprodukte
    document.addEventListener('DOMContentLoaded', () => {
      // Zufällige Beispielbilder (Placeholder)
      const sampleImages = [
        'https://placehold.co/400x300/00ffcc/000000?text=Premium+Smartwatch',
        'https://placehold.co/400x300/ff6b6b/000000?text=Elektronik',
        'https://placehold.co/400x300/4dabf7/000000?text=Kleidung',
        'https://placehold.co/400x300/40c057/000000?text=Fahrrad'
      ];
      
      const sampleProducts = [
        { id: "1", title: "Premium Kopfhörer", description: "Kabellose Noise-Cancelling Kopfhörer mit 30h Akkulaufzeit. Perfekt für unterwegs und im Homeoffice. Lieferumfang: Kopfhörer, Ladekabel, Tragetasche.", start: 199.99, min: 99.99, drop: 10, timer: 2, category: "electronics", condition: "Neu", model: "SoundMax Pro X3", images: [sampleImages[1]], createdAt: new Date(Date.now() - 15 * 60 * 1000).toISOString(), sellerId: "seller-1", sellerName: "AudioExperte", sold: false },
        { id: "2", title: "Smart Watch Pro", description: "Smartwatch mit Fitness-Tracking und Herzfrequenzmessung. Wasserdicht bis 50m. Kompatibel mit iOS und Android. Display: 1.3 Zoll AMOLED.", start: 249.99, min: 149.99, drop: 15, timer: 3, category: "electronics", condition: "Refurbished", model: "TechWatch 2023", images: [sampleImages[0]], createdAt: new Date(Date.now() - 45 * 60 * 1000).toISOString(), sellerId: "seller-2", sellerName: "TechDeals", sold: false },
        { id: "3", title: "Designer Jeans", description: "Premium Denim-Jeans im Slim Fit, waschbar bei 40°C. Material: 98% Baumwolle, 2% Elasthan. Made in Italy. Nur trocknergeeignet.", start: 89.99, min: 39.99, drop: 5, timer: 1, category: "clothing", condition: "Neu mit Etikett", size: "32/32", images: [sampleImages[2]], createdAt: new Date(Date.now() - 10 * 60 * 1000).toISOString(), sellerId: "seller-3", sellerName: "FashionStore", sold: false },
        { id: "4", title: "Mountainbike", description: "Professionelles Mountainbike mit Federgabel und Scheibenbremsen. 21-Gang Schaltung. Rahmengröße: 56cm. Ideal für Trail und Cross-Country.", start: 799.99, min: 399.99, drop: 20, timer: 5, category: "bike", condition: "Gebraucht", images: [sampleImages[3]], createdAt: new Date(Date.now() - 30 * 60 * 1000).toISOString(), sellerId: "seller-4", sellerName: "BikeWorld", sold: false },
        { id: "5", title: "Liam (li)", description: "Geboren 2006, Offizieller Lieblingssport ist es, einen Audi RS7 bis ins kleinste Detail zu konfigurieren, ohne jemals einen zu kaufen. Seine Ernährung besteht größtenteils aus Energy-Drinks, spontanen Existenzkrisen und der Vorstellung, irgendwann reich genug zu sein. Liam ist Gen Z in Reinform: halb Meme, halb Philosophie, halb Bro, was mach ich eigentlich mit meinem Leben. Er ist direkt, ehrlich, manchmal asozial, aber genau das macht ihn auf seine Art irgendwie real", start: 100000000, min: 399.99, drop: 20, timer: 5000, category: "thegoat", condition: "NEU", images: ["assets\\20250906_002510.jpg"], createdAt: new Date(Date.now() - 30 * 60 * 1000).toISOString(), sellerId: "seller-5", sellerName: "THE GOAT", sold: false }
      ];
      sampleProducts.forEach(p => addProduct(p));
      
      // Benachrichtigungsbadge aktualisieren
      updateNotificationBadge();
      
      // Nach Benachrichtigungen fragen
      setTimeout(requestNotificationPermission, 3000);
      
      // Starte kontinuierliche Animation
      startContinuousAnimation();
    });
  </script>
</body>
</html>